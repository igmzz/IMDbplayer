<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>IMDb Player</title>
<link rel="icon" href="carrete-de-pelicula.ico" type="image/x-icon" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet" />
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Montserrat", sans-serif;
  }
  html, body {
    height: 100%;
    width: 100%;
    overflow-y: scroll;
    scroll-behavior: smooth;
    background-color: black;
  }
  body {
    background: linear-gradient(rgba(0, 10, 30, 0.95), rgba(2, 8, 25, 0.95)),
      url("https://images.unsplash.com/photo-1532375810709-7bfc0c3d75d3?auto=format&fit=crop&w=1950&q=80")
      no-repeat center center fixed;
    background-size: cover;
    color: #fff;
    transition: background 1.5s ease-in-out;
  }
  #main {
    display: flex;
    flex-direction: column;
    padding: 25px;
    max-width: 1200px;
    margin: 0 auto;
  }
  h2 {
    margin-bottom: 20px;
    color: #fff;
    text-align: center;
    font-weight: 700;
    letter-spacing: 1px;
  }
  #modeSelector {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
  }
  #modeSelector button {
    padding: 22px 50px;
    font-size: 24px;
    border: none;
    border-radius: 12px;
    background: #001a33;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  #modeSelector button:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
  }
  #searchContainer {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 25px;
  }
  input, button.action-btn {
    font-family: "Montserrat", sans-serif;
  }
  input {
    padding: 14px 20px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    outline: none;
    background: rgba(0, 25, 50, 0.6);
    color: #fff;
    transition: background 0.3s ease;
  }
  input::placeholder {
    color: #bbb;
  }
  input:focus {
    background: rgba(0, 25, 50, 0.85);
    transform: scale(1.05);
  }
  button.action-btn {
    padding: 14px 30px;
    font-size: 16px;
    border-radius: 12px;
    background: #2c9cff;
    color: #fff;
    border: none;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.3s ease;
  }
  button.action-btn:hover {
    background: #1a7ed1;
    transform: scale(1.05);
  }
  #results {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px 40px;
    padding: 0;
  }
  .card, .subs-card {
    background: #02121e;
    width: 140px;
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .card:hover, .subs-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 15px 40px rgba(44, 156, 255, 0.7);
  }
  .poster {
    width: 140px;
    height: 200px;
    object-fit: cover;
    border-bottom: 4px solid #2c9cff;
    transition: transform 0.5s ease;
  }
  .card:hover .poster, .subs-card:hover .poster {
    transform: scale(1.05);
  }
  .title {
    padding: 10px 12px;
    font-weight: 700;
    font-size: 12px;
    color: #aad8ff;
    text-align: center;
    user-select: none;
    height: 48px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .expanded-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: rgba(0, 25, 50, 0.9);
    padding: 20px;
    border-radius: 26px;
    width: 90%;
    max-width: 800px;
    margin: 0 auto 30px auto;
    box-shadow: 0 12px 30px rgba(44, 156, 255, 0.7);
    text-align: center;
    opacity: 0;
    transform: translateY(30px);
    animation: fadeSlideIn 0.5s forwards;
  }
  @keyframes fadeSlideIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .expanded-card img {
    width: 150px;
    height: 225px;
    object-fit: cover;
    border-radius: 26px;
    margin-bottom: 15px;
  }
  .expanded-info {
    color: #fff;
    font-size: 14px;
    line-height: 1.8;
  }
  .expanded-info h3 {
    margin-bottom: 15px;
  }
  #playerControls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 10px;
    position: relative;
  }

  /* Modal Styles */
  #playerChoiceModal {
    display: none;
    position: fixed;
    z-index: 20000;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
  }
  #playerChoiceContent {
    background: #001a33;
    border-radius: 20px;
    padding: 30px;
    width: 320px;
    box-shadow: 0 12px 40px rgba(44, 156, 255, 0.8);
    text-align: center;
    color: #aad8ff;
  }
  #playerChoiceContent h3 {
    margin-bottom: 20px;
    color: #2c9cff;
  }
  .playerChoiceBtn {
    background: #2c9cff;
    border: none;
    color: #fff;
    font-size: 18px;
    padding: 14px 0;
    margin: 10px 0;
    border-radius: 12px;
    width: 100%;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .playerChoiceBtn:hover {
    background: #1a7ed1;
  }
  #playerChoiceCancelBtn {
    background: transparent;
    border: none;
    color: #888;
    margin-top: 15px;
    font-size: 14px;
    cursor: pointer;
  }
  #playerChoiceCancelBtn:hover {
    color: #2c9cff;
  }
  #movieSynopsisBox {
    max-width: 800px;
    margin: 20px auto 30px auto;
    font-size: 16px;
    line-height: 1.4;
    padding: 0 16px;
    color: #ddd;
  }
  #similarMoviesSection {
    max-width: 900px;
    margin: 0 auto 40px auto;
    text-align: center;
  }
  #similarMoviesSection h3 {
    color: #2c9cff;
    margin-bottom: 20px;
  }
  #similarMovies {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px 30px;
  }
  .similar-card {
    background: #02121e;
    width: 120px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.7);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .similar-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(44,156,255,0.6);
  }
  .similar-poster {
    width: 120px;
    height: 170px;
    object-fit: cover;
    border-bottom: 3px solid #2c9cff;
    transition: transform 0.4s ease;
  }
  .similar-card:hover .similar-poster {
    transform: scale(1.07);
  }
  /* F√∫tbol iframe container */
  #footballEmbedWrapper {
    width: 100%;
    max-width: 1200px;
    height: 720px;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 12px 30px rgba(44, 156, 255, 0.7);
    position: relative;
  }
  #footballEmbedWrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  /* Dropdown f√∫tbol */
  #footballDropdown {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 10001;
  }
  #footballDropdown select {
    padding: 10px 15px;
    border-radius: 12px;
    border: none;
    font-size: 16px;
    background-color: #001a33;
    color: #aad8ff;
    cursor: pointer;
    outline: none;
    transition: background-color 0.3s ease;
  }
  #footballDropdown select:hover {
    background-color: #003166;
  }
  /* Bot√≥n circular para extensi√≥n de subt√≠tulos en verde */
  #subtitleExtensionBtn {
    position: absolute;
    top: 15px;
    right: -60px;
    width: 48px;
    height: 48px;
    background-color: #28a745; /* verde */
    border-radius: 50%;
    cursor: pointer;
    overflow: hidden;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 12px;
    box-shadow: 0 0 10px rgba(40, 167, 69, 0.7);
    transition: width 0.4s ease, padding 0.4s ease;
    padding: 0;
    text-decoration: none;
    z-index: 10002;
  }
  #subtitleExtensionBtn:hover {
    width: 180px;
    padding: 0 12px;
    border-radius: 24px;
    text-align: left;
  }
  #subtitleExtensionBtn span {
    opacity: 0;
    transition: opacity 0.3s ease 0.15s;
    margin-left: 8px;
  }
  #subtitleExtensionBtn:hover span {
    opacity: 1;
  }
  /* Nueva secci√≥n de info expandida para subs */
  #subsInfoBox {
    max-width: 800px;
    margin: 20px auto 30px auto;
    font-size: 16px;
    line-height: 1.4;
    padding: 20px;
    background: rgba(0, 25, 50, 0.9);
    border-radius: 26px;
    box-shadow: 0 12px 30px rgba(44, 156, 255, 0.7);
    text-align: center;
    color: #ddd;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: fadeSlideIn 0.5s forwards;
  }
  #subsInfoBox img {
    width: 150px;
    height: 225px;
    object-fit: cover;
    border-radius: 26px;
    margin-bottom: 15px;
  }
  #subsInfoBox h3 {
    color: #aad8ff;
    margin-bottom: 10px;
  }
  #subsInfoBox p {
    color: #ccc;
    margin: 4px 0;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  #subsInfoBox button.copy-btn {
    background: #2c9cff;
    border: none;
    color: #fff;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #subsInfoBox button.copy-btn:hover {
    background: #1a7ed1;
  }
  #opensubLinkBox {
    margin-top: 15px;
    background: #02121e;
    padding: 12px 20px;
    border-radius: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.8);
  }
  #opensubLinkBox a {
    color: #2c9cff;
    font-weight: 700;
    font-size: 16px;
    text-decoration: none;
  }
  #opensubLinkBox a:hover {
    text-decoration: underline;
  }

  /* Series Section */
  #seriesSection {
    display: none;
  }
  #seriesSearchContainer {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 15px;
  }
  #seriesResults {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px 40px;
  }
  #seriesControls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
  }
  #seriesControls input[type="number"] {
    width: 90px;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    outline: none;
    background: rgba(0, 25, 50, 0.6);
    color: #fff;
    transition: background 0.3s ease;
  }
  #seriesControls input[type="number"]::placeholder {
    color: #bbb;
  }
  #seriesControls input[type="number"]:focus {
    background: rgba(0, 25, 50, 0.85);
    transform: scale(1.05);
  }
</style>
</head>
<body>
  <div id="main">
    <h2>IMDb Player</h2>
    <div id="modeSelector">
      <button onclick="showMode('movies')">Pel√≠culas üé¨</button>
      <button onclick="showMode('subs')">Subs üìù</button>
      <button onclick="showMode('series')">Series üì∫</button>
      <button onclick="showMode('football')">F√∫tbol ‚öΩ</button>
    </div>

    <!-- Pel√≠culas Section -->
    <div id="moviesSection" style="display:block;">
      <div id="searchContainer">
        <input type="text" id="titleInput" placeholder="Escribe el t√≠tulo..." />
        <button class="action-btn" id="searchBtn">Buscar</button>
      </div>
      <div id="results"></div>
      <div id="moviesPagination" class="pagination"></div>
      <div id="playerWrapper">
        <div id="playerControls">
          <!-- Bot√≥n Cargar pel√≠cula -->
          <button class="action-btn" id="loadMovieBtn" onclick="openPlayerChoiceModal()">‚ñ∂Ô∏è Cargar pel√≠cula</button>
          <input type="hidden" id="tmdbInput" value="" />
        </div>
        <div id="playerEmbedWrapper">
          <!-- iframe reproductor pel√≠cula con atributos para fullscreen -->
          <iframe id="moviePlayerIframe" src="" width="100%" height="480" style="border:none; border-radius: 16px; box-shadow: 0 12px 30px rgba(44, 156, 255, 0.7); background: #000;" allowfullscreen allow="encrypted-media"></iframe>
          <a href="https://chromewebstore.google.com/detail/kkkbiiikppgjdiebcabomlbidfodipjg?utm_source=item-share-cb" target="_blank" id="subtitleExtensionBtn" title="Extensi√≥n para subt√≠tulos" aria-label="Extensi√≥n para subt√≠tulos">
            <svg xmlns="http://www.w3.org/2000/svg" fill="white" height="24" viewBox="0 0 24 24" width="24"><path d="M3 7v10h18V7H3zm16 8H5v-6h14v6zm-3-4h-2v3h-2v-3H8v-2h2V8h2v3h2v2z"/></svg>
            <span>EXTENSI√ìN PARA SUBT√çTULOS</span>
          </a>
        </div>
        <div id="movieSynopsisBox"></div>
        <div id="similarMoviesSection" style="display:none;">
          <h3>Pel√≠culas similares a tu selecci√≥n</h3>
          <div id="similarMovies"></div>
        </div>
      </div>
    </div>

    <!-- Subs Section -->
    <div id="subsSection" style="display:none;">
      <div id="subsSearchContainer" style="display:flex; justify-content:center; gap:15px; margin-bottom:25px;">
        <input type="text" id="subsTitleInput" placeholder="Buscar pel√≠cula para subs..." />
        <button class="action-btn" id="subsSearchBtn">Buscar</button>
      </div>
      <div id="subsResults" style="display:flex; flex-wrap: wrap; justify-content:center; gap:30px 40px;"></div>
      <div id="subsInfoBox"></div>
      <div id="subsPlayerEmbedWrapper" style="margin-top: 20px; width: 100%; height: 480px; max-width: 800px; margin-left: auto; margin-right: auto; border-radius: 16px; overflow: hidden; box-shadow: 0 12px 30px rgba(44, 156, 255, 0.7); background: #000;"></div>
    </div>

    <!-- Series Section -->
    <div id="seriesSection" style="display:none;">
      <div id="seriesSearchContainer">
        <input type="text" id="seriesTitleInput" placeholder="Buscar serie..." />
        <button class="action-btn" id="seriesSearchBtn">Buscar</button>
      </div>
      <div id="seriesResults"></div>
      <div id="seriesControls" style="display:none;">
        <input type="number" id="seasonInput" placeholder="Temporada" min="1" />
        <input type="number" id="episodeInput" placeholder="Episodio" min="1" />
        <button class="action-btn" id="loadSeriesBtn">‚ñ∂Ô∏è Cargar pel√≠cula</button>
      </div>
    </div>

    <!-- F√∫tbol Section -->
    <div id="footballSection" style="display:none;">
      <div id="footballEmbedWrapper">
        <div id="footballDropdown">
          <select id="footballSiteSelect" aria-label="Seleccionar sitio de f√∫tbol">
            <option value="https://lmao.love/channels/">Ay-Lmao</option>
            <option value="https://strmd.link/">Streamed.pk</option>
            <option value="https://ovogoaal.com/">Ovogoaal</option>
          </select>
        </div>
        <iframe src="https://rivestream.org/livesports/football" allowfullscreen allow="encrypted-media" id="footballIframe"></iframe>
      </div>
    </div>
  </div>

  <!-- Modal para selecci√≥n de reproductor -->
  <div id="playerChoiceModal" role="dialog" aria-modal="true" aria-labelledby="playerChoiceTitle">
    <div id="playerChoiceContent">
      <h3 id="playerChoiceTitle">Selecciona el reproductor para la pel√≠cula</h3>
      <button class="playerChoiceBtn" data-player="VidSrc">VidSrc</button>
      <button class="playerChoiceBtn" data-player="IVW">IVW</button>
      <button id="playerChoiceCancelBtn">Cancelar</button>
    </div>
  </div>

<script>
  const tmdbApiKey = "b60c8fb1893bba0f1380297e7a40257e";
  const tmdbBaseURL = "https://api.themoviedb.org/3";
  let currentMovieId = "";
  let currentPage = 1;
  let totalPages = 1;

  // Series section variables
  let currentSeriesId = "";
  let selectedSeason = null;
  let selectedEpisode = null;

  function slugify(text) {
    return text.toString().toLowerCase().normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9 -]/g, "")
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-+|-+$/g, "");
  }

  function showMode(mode) {
    document.getElementById("moviesSection").style.display = (mode === "movies") ? "block" : "none";
    document.getElementById("subsSection").style.display = (mode === "subs") ? "block" : "none";
    document.getElementById("seriesSection").style.display = (mode === "series") ? "block" : "none";
    document.getElementById("footballSection").style.display = (mode === "football") ? "block" : "none";
  }

  // Funci√≥n para actualizar paginaci√≥n sin cambiar dise√±o ni llamadas
  function updatePagination(container, type) {
    container.innerHTML = "";
    if (totalPages <= 1) return;
    
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "¬´ Anterior";
    prevBtn.disabled = currentPage <= 1;
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        if(type === "movies") searchMovie(currentPage);
      }
    };
    container.appendChild(prevBtn);

    const pageInfo = document.createElement("span");
    pageInfo.style.color = "#aad8ff";
    pageInfo.style.margin = "0 15px";
    pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages}`;
    container.appendChild(pageInfo);

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Siguiente ¬ª";
    nextBtn.disabled = currentPage >= totalPages;
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        if(type === "movies") searchMovie(currentPage);
      }
    };
    container.appendChild(nextBtn);
  }

  // ---------- Pel√≠culas -----------

  const results = document.getElementById("results");
  const tmdbInput = document.getElementById("tmdbInput");
  const moviesPagination = document.getElementById("moviesPagination");
  const movieSynopsisBox = document.getElementById("movieSynopsisBox");
  const moviePlayerIframe = document.getElementById("moviePlayerIframe");

  async function startSearch() {
    results.innerHTML = "";
    moviesPagination.innerHTML = "";
    movieSynopsisBox.innerHTML = "";
    currentMovieId = "";
    const currentTitle = document.getElementById("titleInput").value.trim();
    if (!currentTitle) return;
    await searchMovie(currentPage);
  }

  document.getElementById("searchBtn").addEventListener("click", startSearch);
  document.getElementById("titleInput").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      startSearch();
    }
  });

  async function searchMovie(page) {
    try {
      const currentTitle = document.getElementById("titleInput").value.trim();
      const url = `${tmdbBaseURL}/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(currentTitle)}&page=${page}&language=es-ES`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Error en la respuesta de TMDB");
      const data = await response.json();
      if (!data.results || data.results.length === 0) {
        results.innerHTML = "<p>No se encontraron resultados.</p>";
        moviesPagination.innerHTML = "";
        return;
      }
      results.innerHTML = "";
      totalPages = data.total_pages;
      updatePagination(moviesPagination, "movies");
      data.results.forEach((movie) => {
        const card = document.createElement("div");
        card.className = "card";
        const poster = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : "https://via.placeholder.com/140x200?text=No+Image";
        card.innerHTML = `<img class="poster" src="${poster}"><div class="title">${movie.title} (${movie.release_date ? movie.release_date.slice(0,4) : "---"})</div>`;
        card.onclick = async () => {
          await loadMovieDetails(movie.id);
        };
        results.appendChild(card);
      });
    } catch (error) {
      results.innerHTML = `<p>Error al buscar pel√≠culas: ${error.message}</p>`;
      moviesPagination.innerHTML = "";
    }
  }

  async function loadMovieDetails(movieId) {
    results.innerHTML = "";
    moviesPagination.innerHTML = "";
    movieSynopsisBox.innerHTML = "";
    currentMovieId = "";
    try {
      const detailsUrl = `${tmdbBaseURL}/movie/${movieId}?api_key=${tmdbApiKey}&language=es-ES&append_to_response=credits,external_ids`;
      const detailsRes = await fetch(detailsUrl);
      if (!detailsRes.ok) {
        results.innerHTML = "<p>Error al cargar detalles de la pel√≠cula.</p>";
        return;
      }
      const details = await detailsRes.json();
      const posterLarge = details.poster_path ? `https://image.tmdb.org/t/p/w300${details.poster_path}` : "https://via.placeholder.com/150x225?text=No+Image";
      const director = details.credits.crew.find(c => c.job === "Director");
      const castTop5 = details.credits.cast.slice(0,5);
      const castNames = castTop5.map(c => c.name).join(", ");
      const countries = details.production_countries.map(c => c.iso_3166_1);
      const expanded = document.createElement("div");
      expanded.className = "expanded-card";
      expanded.innerHTML = `
        <img src="${posterLarge}">
        <div class="expanded-info">
          <h3>${details.title} (${details.release_date ? details.release_date.slice(0,4) : "---"})</h3>
          <p><strong>Director:</strong> ${director ? director.name : "N/D"}</p>
          <p><strong>Reparto:</strong> ${castNames}</p>
          <p><strong>IMDb:</strong> <span style="color:#2c9cff">${details.vote_average}</span></p>
          <p><strong>G√©nero:</strong> ${details.genres.map(g => g.name).join(", ")}</p>
          <p><strong>Duraci√≥n:</strong> ${details.runtime} min</p>
          <p><strong>Pa√≠s:</strong> ${details.production_countries.map(c => c.name).join(", ")}</p>
        </div>`;
      results.appendChild(expanded);

      tmdbInput.value = details.id || "";
      tmdbInput.setAttribute("data-title", slugify(details.title));
      movieSynopsisBox.innerHTML = `<span class="movie-synopsis-label">Sinopsis:</span> ${details.overview || "Sinopsis no disponible."}`;

      currentMovieId = details.id;

      // Por defecto cargar IVW
      if(currentMovieId){
        moviePlayerIframe.src = `https://rivestream.org/watch?type=movie&id=${currentMovieId}`;
      } else {
        moviePlayerIframe.src = "";
      }
    } catch (error) {
      results.innerHTML = `<p>Error al cargar detalles: ${error.message}</p>`;
    }
  }

  // Funci√≥n para abrir modal de selecci√≥n de reproductor
  const playerChoiceModal = document.getElementById("playerChoiceModal");
  const playerChoiceContent = playerChoiceModal.querySelector("#playerChoiceContent");
  let playerChoiceCancelBtn = playerChoiceModal.querySelector("#playerChoiceCancelBtn");

  function openPlayerChoiceModal() {
    if (!currentMovieId) {
      alert("Por favor, selecciona primero una pel√≠cula haciendo clic en alguna tarjeta.");
      return;
    }
    playerChoiceModal.style.display = "flex";
  }

  // Evento para botones en modal reproductores para pel√≠culas
  playerChoiceContent.addEventListener("click", (event) => {
    if(event.target.classList.contains("playerChoiceBtn")){
      const player = event.target.getAttribute("data-player");
      let url = "";
      switch(player) {
        case "IVW":
          url = `https://rivestream.org/watch?type=movie&id=${currentMovieId}`;
          moviePlayerIframe.src = url; // Cambia dentro de iframe la fuente
          break;
        case "VidSrc":
          url = `https://vidsrc.xyz/embed/movie/${currentMovieId}`;
          moviePlayerIframe.src = url; // Cambia dentro de iframe la fuente
          break;
      }
      // No abrir ventana nueva, s√≥lo cargar en iframe
      playerChoiceModal.style.display = "none";
    }
  });

  // Evento cancelar modal
  playerChoiceCancelBtn.addEventListener("click", () => {
    playerChoiceModal.style.display = "none";
  });

  // Cerramos modal si hacemos clic fuera del contenido
  window.addEventListener("click", (event) => {
    if (event.target === playerChoiceModal) {
      playerChoiceModal.style.display = "none";
    }
  });

  // ---------- Subs Section ----------

  const subsResults = document.getElementById("subsResults");
  const subsPlayerEmbedWrapper = document.getElementById("subsPlayerEmbedWrapper");
  const subsInfoBox = document.getElementById("subsInfoBox");

  document.getElementById("subsSearchBtn").addEventListener("click", startSubsSearch);
  document.getElementById("subsTitleInput").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      startSubsSearch();
    }
  });

  async function startSubsSearch() {
    const query = document.getElementById("subsTitleInput").value.trim();
    if (!query) return;
    subsResults.innerHTML = "";
    subsPlayerEmbedWrapper.innerHTML = "";
    subsInfoBox.innerHTML = "";
    try {
      // Buscar pel√≠culas en TMDb (solo para obtener lista con IDs)
      const url = `${tmdbBaseURL}/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}&language=es-ES`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Error en la respuesta de TMDb");
      const data = await response.json();
      if (!data.results || data.results.length === 0) {
        subsResults.innerHTML = "<p>No se encontraron resultados.</p>";
        return;
      }
      data.results.forEach(movie => {
        const card = document.createElement("div");
        card.className = "subs-card";
        const poster = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : "https://via.placeholder.com/140x200?text=No+Image";
        card.innerHTML = `<img class="poster" src="${poster}"><div class="title">${movie.title} (${movie.release_date ? movie.release_date.slice(0,4) : "---"})</div>`;
        card.onclick = () => loadSubsByMovieId(movie.id);
        subsResults.appendChild(card);
      });
    } catch (error) {
      subsResults.innerHTML = `<p>Error al buscar pel√≠culas: ${error.message}</p>`;
    }
  }

  // Nueva funci√≥n auxiliar para formatear imdbId para opensubtitles.org
  function formatImdbIdForOpenSub(imdbId) {
    if (!imdbId) return "";
    // Quitar prefijo tt, ceros delante del primer n√∫mero significativo
    let numPart = imdbId.toLowerCase().replace(/^tt/, "");
    numPart = numPart.replace(/^0+/, "");
    return numPart;
  }

  async function loadSubsByMovieId(movieId) {
    subsResults.innerHTML = "";
    subsPlayerEmbedWrapper.innerHTML = "";
    subsInfoBox.innerHTML = "";
    try {
      const detailsUrl = `${tmdbBaseURL}/movie/${movieId}?api_key=${tmdbApiKey}&language=es-ES`;
      const detailsRes = await fetch(detailsUrl);
      if (!detailsRes.ok) {
        subsResults.innerHTML = "<p>Error al obtener datos de la pel√≠cula.</p>";
        return;
      }
      const details = await detailsRes.json();
      const year = details.release_date ? details.release_date.slice(0,4) : "";
      const originalTitle = details.original_title || details.title || "";
      const poster = details.poster_path ? `https://image.tmdb.org/t/p/w300${details.poster_path}` : "https://via.placeholder.com/150x225?text=No+Image";
      const imdbIdRaw = details.imdb_id || "";
      const imdbIdFormatted = formatImdbIdForOpenSub(imdbIdRaw);
      const tmdbId = details.id || "N/D";

      // url modificada para opensubtitles.org en espa√±ol con ssp=spa y imdbid formateado
      const openSubUrl = `https://www.opensubtitles.org/es/search/sublanguageid-spa/moviefps-23.976/imdbid-${imdbIdFormatted}`;

      subsInfoBox.innerHTML = `
        <img src="${poster}" alt="${originalTitle}" />
        <h3>${details.title} (${year})</h3>
        <p><strong>IMDb ID:</strong> ${imdbIdRaw} <button class="copy-btn" onclick="copyToClipboard('${imdbIdRaw}')">Copiar</button></p>
        <p><strong>TMDb ID:</strong> ${tmdbId} <button class="copy-btn" onclick="copyToClipboard('${tmdbId}')">Copiar</button></p>
        <div id="opensubLinkBox">
          <a href="${openSubUrl}" target="_blank" rel="noopener noreferrer" aria-label="Ver subt√≠tulos en OpenSubtitles para ${details.title}">
            Ver subt√≠tulos en OpenSubtitles
          </a>
        </div>
      `;
    } catch (error) {
      subsResults.innerHTML = `<p>Error al cargar subt√≠tulos: ${error.message}</p>`;
    }
  }

  // ---------- Series Section ----------

  const seriesResults = document.getElementById("seriesResults");
  const seriesTitleInput = document.getElementById("seriesTitleInput");
  const seriesSearchBtn = document.getElementById("seriesSearchBtn");
  const seriesControls = document.getElementById("seriesControls");
  const seasonInput = document.getElementById("seasonInput");
  const episodeInput = document.getElementById("episodeInput");
  const loadSeriesBtn = document.getElementById("loadSeriesBtn");

  seriesSearchBtn.addEventListener("click", startSeriesSearch);
  seriesTitleInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      event.preventDefault();
      startSeriesSearch();
    }
  });

  async function startSeriesSearch() {
    const query = seriesTitleInput.value.trim();
    if (!query) return;
    seriesResults.innerHTML = "";
    seriesControls.style.display = "none";
    currentSeriesId = "";
    try {
      const url = `${tmdbBaseURL}/search/tv?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}&language=es-ES`;
      const response = await fetch(url);
      if (!response.ok) throw new Error("Error en la respuesta de TMDB");
      const data = await response.json();
      if (!data.results || data.results.length === 0) {
        seriesResults.innerHTML = "<p>No se encontraron resultados.</p>";
        return;
      }
      data.results.forEach(show => {
        const card = document.createElement("div");
        card.className = "subs-card";
        const poster = show.poster_path ? `https://image.tmdb.org/t/p/w200${show.poster_path}` : "https://via.placeholder.com/140x200?text=No+Image";
        card.innerHTML = `<img class="poster" src="${poster}"><div class="title">${show.name} (${show.first_air_date ? show.first_air_date.slice(0,4) : "---"})</div>`;
        card.onclick = () => loadSeriesById(show.id);
        seriesResults.appendChild(card);
      });
    } catch (error) {
      seriesResults.innerHTML = `<p>Error al buscar series: ${error.message}</p>`;
    }
  }

  async function loadSeriesById(seriesId) {
    seriesResults.innerHTML = "";
    seriesControls.style.display = "flex"; // Mostrar controles de temporada y episodio
    currentSeriesId = seriesId;
    seasonInput.value = "";
    episodeInput.value = "";
  }

  // Cargar enlaces de reproductores para la serie seg√∫n temporada y episodio
  loadSeriesBtn.addEventListener("click", () => {
    if (!currentSeriesId) {
      alert("Por favor, selecciona primero una serie haciendo clic en alguna tarjeta.");
      return;
    }
    selectedSeason = seasonInput.value.trim();
    selectedEpisode = episodeInput.value.trim();
    if (!selectedSeason || !selectedEpisode || isNaN(selectedSeason) || isNaN(selectedEpisode) || selectedSeason < 1 || selectedEpisode < 1) {
      alert("Por favor, ingresa un n√∫mero v√°lido para temporada y episodio.");
      return;
    }

    // Construir URLs para los reproductores
    const videasyUrl = `https://player.videasy.net/tv/${currentSeriesId}/${selectedSeason}/${selectedEpisode}`;
    const vidfastUrl = `https://vidfast.pro/tv/${currentSeriesId}/${selectedSeason}/${selectedEpisode}`;
    const vidsrcUrl = `https://vidsrc.xyz/embed/tv/${currentSeriesId}/${selectedSeason}/${selectedEpisode}`;

    // Mostrar modal con opciones para reproductor (reusamos el modal existente con cambio temporal en botones)
    openPlayerChoiceModalSeries(videasyUrl, vidfastUrl, vidsrcUrl);
  });

  function openPlayerChoiceModalSeries(videasyUrl, vidfastUrl, vidsrcUrl) {
    const modal = playerChoiceModal;
    const content = playerChoiceModal.querySelector("#playerChoiceContent");

    // Cambiamos contenido para reproductores series
    content.innerHTML = `
      <h3 id="playerChoiceTitle">Selecciona el reproductor para la serie</h3>
      <button class="playerChoiceBtn" data-url="${videasyUrl}">Videasy</button>
      <button class="playerChoiceBtn" data-url="${vidfastUrl}">Vidfast</button>
      <button class="playerChoiceBtn" data-url="${vidsrcUrl}">VidSrc</button>
      <button id="playerChoiceCancelBtn">Cancelar</button>
    `;

    modal.style.display = "flex";

    // A√±adimos eventos a botones nuevos
    content.querySelectorAll(".playerChoiceBtn").forEach(button => {
      button.addEventListener("click", () => {
        const url = button.getAttribute("data-url");
        modal.style.display = "none";
        if (url) window.open(url, "_blank");
      });
    });

    // Evento para cancelar
    content.querySelector("#playerChoiceCancelBtn").addEventListener("click", () => {
      modal.style.display = "none";
      // Restaurar modal original para pel√≠culas al cerrar
      restorePlayerChoiceModal();
    });

    // Cerrar modal click fuera
    window.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.style.display = "none";
        restorePlayerChoiceModal();
      }
    }, { once: true });
  }

  function restorePlayerChoiceModal() {
    const content = playerChoiceModal.querySelector("#playerChoiceContent");
    content.innerHTML = `
      <h3 id="playerChoiceTitle">Selecciona el reproductor para la pel√≠cula</h3>
      <button class="playerChoiceBtn" data-player="VidSrc">VidSrc</button>
      <button class="playerChoiceBtn" data-player="IVW">IVW</button>
      <button id="playerChoiceCancelBtn">Cancelar</button>
    `;

    // Vuelven a funcionar eventos normales para pel√≠culas
    const buttons = content.querySelectorAll(".playerChoiceBtn");
    buttons.forEach(button => {
      button.addEventListener("click", () => {
        const player = button.getAttribute("data-player");
        let url = "";
        switch(player) {
          case "IVW":
            url = `https://rivestream.org/watch?type=movie&id=${currentMovieId}`;
            moviePlayerIframe.src = url; // cambia en iframe
            break;
          case "VidSrc":
            url = `https://vidsrc.xyz/embed/movie/${currentMovieId}`;
            moviePlayerIframe.src = url; // cambia en iframe
            break;
        }
        playerChoiceModal.style.display = "none";
      });
    });

    const cancelBtn = content.querySelector("#playerChoiceCancelBtn");
    cancelBtn.addEventListener("click", () => {
      playerChoiceModal.style.display = "none";
    });
  }

  // Copiar al portapapeles funci√≥n gen√©rica
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Copiado al portapapeles: " + text);
    }).catch(() => {
      alert("No se pudo copiar al portapapeles");
    });
  }

  // Cambio de iframe f√∫tbol al seleccionar en desplegable
  const footballSiteSelect = document.getElementById("footballSiteSelect");
  const footballIframe = document.getElementById("footballIframe");

  footballSiteSelect.addEventListener("change", () => {
    const url = footballSiteSelect.value;
    footballIframe.src = url;
  });

  showMode("movies");
</script>
</body>
</html>






